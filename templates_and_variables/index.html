<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Gourav Shah">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Making roles reusable with vars and templates - Ansible Tutorial</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Making roles reusable with vars and templates";
    var mkdocs_page_input_path = "templates_and_variables.md";
    var mkdocs_page_url = "/templates_and_variables/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', '', 'ansible-tutorial.schoolofdevops.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ansible Tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bootcamp</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../setup/">Setting up the Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../ad-hoc/">Ad Hoc Server Maangement with Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../playbooks/">Writing Playbook for Base System Configurations</a>
                </li>
                <li class="">
                    
    <a class="" href="../roles/">Configuring app server environment with Roles</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Making roles reusable with vars and templates</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#templates-and-variables">Templates and Variables</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#variables">Variables</a></li>
        
            <li><a class="toctree-l4" href="#defining-release-versions-with-vars">Defining release versions with vars</a></li>
        
            <li><a class="toctree-l4" href="#creating-application-configurations-dynamically">Creating  application configurations dynamically</a></li>
        
            <li><a class="toctree-l4" href="#beyond-defaults-playing-with-vars-precedence">Beyond defaults - Playing with vars precedence</a></li>
        
            <li><a class="toctree-l4" href="#registered-variables">Registered  Variables</a></li>
        
            <li><a class="toctree-l4" href="#adding-support-for-ubuntu">Adding support for Ubuntu</a></li>
        
            <li><a class="toctree-l4" href="#exercises">Exercises</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../galaxy/">Setting up Load Balancer with Ansible Galaxy</a>
                </li>
                <li class="">
                    
    <a class="" href="../control_structures/">Controlling execution flow with conditionals, iterators and tags</a>
                </li>
                <li class="">
                    
    <a class="" href="../magicvars_envs/">Auto discovery and multi environments</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-vault/">Encrypting sensitive data with Ansible Vault</a>
                </li>
                <li class="">
                    
    <a class="" href="../update/">Setting up Zero Downtime Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../dynamic_inventory/">Dynamic Inventory</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-windows/">Ansible on Windows</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-pull/">Ansible Pull</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-pull/">Ansible Tower</a>
                </li>
                <li class="">
                    
    <a class="" href="../registered_variables/">Registered Variable</a>
                </li>
                <li class="">
                    
    <a class="" href="../custom_modules/">Custom Module</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Troubleshooting</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../troubleshooting/">Troubleshooting Techniques</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ansible Tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Bootcamp &raquo;</li>
        
      
    
    <li>Making roles reusable with vars and templates</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/schoolofdevops/zero-to-docker/edit/master/manuscript/templates_and_variables.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="templates-and-variables">Templates and Variables</h1>
<p>In this  tutorial, we  are going to make the roles that we created earlier dynamically by adding templates and defining variables.</p>
<h2 id="variables">Variables</h2>
<p>Variables are of two types</p>
<ul>
<li>Automatic Variables/ Facts</li>
<li>User Defined Variables</li>
</ul>
<p>Lets try to discover information about our systems by using facts.</p>
<h3 id="finding-facts-about-systems">Finding Facts About Systems</h3>
<ul>
<li>Run the following command to see to facts of db servers  </li>
</ul>
<pre><code>cd chap7
ansible db -m setup
</code></pre>

<p>[Output]</p>
<pre><code>192.168.61.11 | SUCCESS =&gt; {
        &quot;ansible_facts&quot;: {
            &quot;ansible_all_ipv4_addresses&quot;: [
                &quot;10.0.2.15&quot;,
                &quot;192.168.61.11&quot;
            ],
            &quot;ansible_all_ipv6_addresses&quot;: [
                &quot;fe80::a00:27ff:fe30:3251&quot;,
                &quot;fe80::a00:27ff:fe8e:83e0&quot;
.....
                &quot;tz_offset&quot;: &quot;+0100&quot;,
                &quot;weekday&quot;: &quot;Monday&quot;,
                &quot;weekday_number&quot;: &quot;1&quot;,
                &quot;weeknumber&quot;: &quot;36&quot;,
                &quot;year&quot;: &quot;2016&quot;
            }
</code></pre>

<h3 id="filtering-facts">Filtering facts</h3>
<ul>
<li>Use filter attribute to extract specific data</li>
</ul>
<pre><code>ansible db -m setup -a &quot;filter=ansible_distribution&quot;
</code></pre>

<p>[Output]</p>
<pre><code>192.168.61.11 | SUCCESS =&gt; {
  &quot;ansible_facts&quot;: {
      &quot;ansible_distribution&quot;: &quot;CentOS&quot;
  },
  &quot;changed&quot;: false
}  
</code></pre>

<h2 id="defining-release-versions-with-vars">Defining release versions with vars</h2>
<p>Currently, while deploying the application, the versions of the artifacts as well as release directories are defined statically. This should change to vars so that the version can be defined from one place, and dynamically so.</p>
<p>Define the default vars</p>
<p>file: roles/frontend/defaults/main.yml</p>
<pre><code>---
# defaults file for frontend
  app:
    version: 1.5

</code></pre>

<p>Update tasks to use the var defined above,</p>
<p><code>wherever you see version number e.g. 1.1, replace that with {{ app.version }} var.</code></p>
<p>file: roles/frontend/tasks/main.yml</p>
<pre><code>- name: Download and extract the release
  unarchive:
    src: https://github.com/devopsdemoapps/devops-demo-app/archive/{{ app.version }}.tar.gz
    dest: /opt/app/release
    owner: apache
    group: apache
    creates: /opt/app/release/devops-demo-app-{{ app.version }}
    remote_src: yes

- name: create a symlink
  file:
    src: /opt/app/release/devops-demo-app-{{ app.version }}
    dest: /var/www/html/app
    owner: apache
    group: apache
    state: link
</code></pre>

<p><strong>Try This</strong>:
  * Run playbook and check whether the above code works
  * Change the version e.g. 1.4 and check if it has any effect</p>
<h2 id="creating-application-configurations-dynamically">Creating  application configurations dynamically</h2>
<p>Application configs are defined with <strong>config.ini</strong> file.  The version of config.ini as shipped with the application is as follows,</p>
<pre><code>[database]
hostname = DBHOST
username = SQLUSER
password = SQLPASSWORD
dbname = SQLDBNAME

[environment]
environment = ENVNAME

[prefs]
color  = white
fruit  = apple
car    = fiat
laptop = dell
</code></pre>

<p>You should be able to customize these configs. In order to do that, you need to do split this into 2 things as follows,</p>
<ul>
<li><strong>vars</strong> which define the actual properties and allow you to change it from different places</li>
<li>a <strong>jinja2 template</strong> which will collect and process the vars on the fly and create the resulting configs dynamically</li>
</ul>
<h3 id="defining-the-vars-for-app-config">Defining the vars for app config</h3>
<p>file: roles/frontend/defaults/main.yml</p>
<pre><code>---
# defaults file for frontend
  app:
    version: 1.5
    env: LOCALDEV

  fav:
    color: white
    fruit: orange
    car: chevy
    laptop: toshiba

  dbconn:
    host: localhost
    user: root
    pass: changeme
    db: devopsdemo
</code></pre>

<p>Create directory and template file.  You could either use the commands below or directly create it from the graphical editor.</p>
<pre><code>cd roles/frontend
mkdir templates
touch templates/config.ini.j2
</code></pre>

<p>file: roles/frontend/templates/config.ini.j2  </p>
<pre><code>
[database]
hostname = {{ dbconn['host'] }}
username = {{ dbconn['user'] }}
password = {{ dbconn['pass'] }}
dbname = {{ dbconn['db'] }}

[environment]
environment = {{ app['env'] }}

[prefs]
color  = {{ fav['color'] }}
fruit  = {{ fav['fruit'] }}
car    = {{ fav['car'] }}
laptop = {{ fav['laptop'] }}

</code></pre>

<h3 id="adding-task-to-generate-the-config-from-jinja2-template">Adding task to generate  the  config from jinja2 template</h3>
<p>file: roles/frontend/tasks/main.yml ( append the following code to the file)</p>
<pre><code>- name: add application configs
  template:
    src: config.ini.j2
    dest: /var/www/html/app/config.ini
    owner: apache
    group: apache
    mode: 0644
</code></pre>

<p>Now, run the playbook, reload the application page and validate. You should also browse to  http://IPADDRESS:81/app/prefs.php to view if it prints the preferences you defined in the default vars.   </p>
<pre><code>cd chap7
ansible-playbook  app.yml
</code></pre>

<h2 id="beyond-defaults-playing-with-vars-precedence">Beyond defaults - Playing with vars precedence</h2>
<p>Lets define the variables from couple of other places, to learn about the Precedence rules. We will create,
<em> group_vars
</em> playbook vars</p>
<p>Since we are going to define the variables using multi level hashes,  define the way hashes behave when defined from multiple places.</p>
<p>Update <code>chap7/ansible.cfg</code> and add the following,</p>
<pre><code>hash_behaviour=merge
</code></pre>

<p>Lets create group_vars and create a group <strong>prod</strong> to define vars common to all prod hosts.</p>
<pre><code>cd chap7
mkdir group_vars
cd group_vars
touch prod.yml
</code></pre>

<p>Edit <strong>group_vars/prod.yml</strong> file and add the following contents,</p>
<pre><code>---
  fav:
    color: yellow
    fruit: guava
</code></pre>

<p>Lets also add vars to playbook. Edit app.yml and add vars as below,</p>
<pre><code>---
  - hosts: app
    become: true
    vars:
      fav:
        fruit: mango
    roles:
      - apache
      - php
      - frontend
</code></pre>

<p>Execute the playbook and check the output</p>
<pre><code>ansible-playbook app.yml
</code></pre>

<p>If you view the content of the html file generated, you would notice the following,</p>
<pre><code>&lt;h3&gt; color     : yellow &lt;/h3&gt;
&lt;h3&gt; fruit     : mango &lt;/h3&gt;
&lt;h3&gt; car       : chevy &lt;/h3&gt;
&lt;h3&gt; laptop    : toshiba &lt;/h3&gt;
</code></pre>

<table>
<thead>
<tr>
<th align="left">fav item</th>
<th align="left">role defaults</th>
<th align="left">group_vars</th>
<th align="left">playbook_vars</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">color</td>
<td align="left">white</td>
<td align="left"><strong>yellow</strong></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">fruit</td>
<td align="left">orange</td>
<td align="left">guava</td>
<td align="left"><strong>mango</strong></td>
</tr>
<tr>
<td align="left">car</td>
<td align="left"><strong>chevy</strong></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">laptop</td>
<td align="left"><strong>toshiba</strong></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<ul>
<li>value of color comes from group_vars/all.yml</li>
<li>value of fruit comes from playbook vars</li>
<li>value of car and laptop comes from role defaults</li>
</ul>
<h2 id="registered-variables">Registered  Variables</h2>
<p>Lets create a playbook to run a shell command, register the result and display the value of registered variable.</p>
<p>Create <strong>register.yml</strong> in chap7 directory</p>
<pre><code>---
  - name: register variable example
    hosts: local
    tasks:
      - name: install net tools to make ifconfig command available
        package:
          name: net-tools
          state: installed

      - name: run a shell command and register result
        shell: &quot;/sbin/ifconfig eth0&quot;
        register: result

      - name: print registered variable
        debug: var=result
</code></pre>

<p>Execute the playbook to display information about the registered variable.</p>
<pre><code>ansible-playbook  register.yml
</code></pre>

<h2 id="adding-support-for-ubuntu">Adding support for Ubuntu</h2>
<p>Apache role that we have developed supports only RedHat based systems at the moment. To add support for ubuntu (app2), we must handle platform specific differences.</p>
<p>e.g.</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">RedHat</th>
<th align="left">Debian</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Package Name</td>
<td align="left">httpd</td>
<td align="left">apache2</td>
</tr>
<tr>
<td align="left">Service Name</td>
<td align="left">httpd</td>
<td align="left">apache2</td>
</tr>
</tbody>
</table>
<p>OS specific configurations can be defined by creating role vars and by including those in tasks.</p>
<p>file: roles/apache/vars/RedHat.yml</p>
<pre><code>---
apache:
  package:
    name: httpd
  service:
    name: httpd
    status: started
</code></pre>

<p>file: roles/apache/vars/Debian.yml</p>
<pre><code>---
apache:
  package:
    name: apache2
  service:
    name: apache2
    status: started
</code></pre>

<p>Lets now selectively include those var files from tasks/main.yml .  Also selectively call configurations.
file: role/apache/tasks/main.yml</p>
<pre><code>---
# tasks file for apache
  - include_vars: &quot;{{ ansible_os_family }}.yml&quot;
  - include: install.yml
  - include: service.yml
  - include: config_{{ ansible_os_family }}.yml  
</code></pre>

<p>We are now going to create two different config tasks. Since the current config is applicable to RedHat, lets rename it to config_RedHat.yml</p>
<pre><code>mv roles/apache/tasks/config.yml roles/apache/tasks/config_RedHat.yml
</code></pre>

<p>We will now create a new config for Debian</p>
<p>file: roles/apache/tasks/config_Debian.yml</p>
<pre><code>- name: Copying index.html file...
  template: &gt;
    src=index.html.j2
    dest=/var/www/html/index.html
    mode=0777
</code></pre>

<p>Update tasks and handlers to install and start the correct service</p>
<p>tasks/install.yml</p>
<pre><code>---
  - name: install httpd on centos
    package: &gt;
      name={{ apache['package']['name']}}
      state=installed
</code></pre>

<p>tasks/service.yml</p>
<pre><code>---
  - name: start httpd service
    service: &gt;
      name={{ apache['service']['name']}}
      state={{ apache['service']['status']}}
</code></pre>

<p>handlers/main.yml</p>
<pre><code>---
# handlers file for apache
  - name: restart apache service
    service: &gt;
      name={{ apache['service']['name']}}
      state=restarted
</code></pre>

<p>Now add host app3 to the inventory</p>
<p><code>file: environments/prod</code></p>
<pre><code>[app]
app1
app2
app3 ansible_password=codespaces
</code></pre>

<p>and apply playbook</p>
<pre><code>ansible-playbook app.yml
</code></pre>

<h2 id="exercises">Exercises</h2>
<ul>
<li>Create host specific variables in host_vars/HOSTNAME for one of the app servers, and define some variables values specific to the host. See the output after applying playbook on this node.</li>
<li>Generate MySQL Configurations dynamically using templates and modules.</li>
<li>Create a template for my.cnf.  Name it as roles/mysql/templates/my.cnf.j2</li>
<li>Replace parameter values with templates variables</li>
<li>Define variables in role defaults.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../galaxy/" class="btn btn-neutral float-right" title="Setting up Load Balancer with Ansible Galaxy">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../roles/" class="btn btn-neutral" title="Configuring app server environment with Roles"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/schoolofdevops/zero-to-docker/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../roles/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../galaxy/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
