<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Configuring app server environment with Roles - Ultimate Ansible Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Configuring app server environment with Roles";
    var mkdocs_page_input_path = "roles.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Ansible Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bootcamp</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../setup/">Setting up the Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../ad-hoc/">Ad Hoc Server Maangement with Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../playbooks/">Writing Playbook for Base System Configurations</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Configuring app server environment with Roles</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#configuring-app-server-environment-with-roles">Configuring app server environment with Roles</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#creating-role-scaffolding-for-apache">Creating Role Scaffolding for Apache</a></li>
        
            <li><a class="toctree-l4" href="#writing-tasks-to-install-and-start-apache-web-service">Writing Tasks to Install and Start  Apache Web Service</a></li>
        
            <li><a class="toctree-l4" href="#create-and-apply-playbook-to-configure-app-servers">Create and apply playbook to configure app servers</a></li>
        
            <li><a class="toctree-l4" href="#managing-configurations">Managing Configurations</a></li>
        
            <li><a class="toctree-l4" href="#create-a-role-to-install-php">Create a role to install php</a></li>
        
            <li><a class="toctree-l4" href="#systems-role-dependencies-and-nested-roles">Systems role, dependencies and nested roles</a></li>
        
            <li><a class="toctree-l4" href="#exercises">Exercises</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../templates_and_variables/">Making roles reusable with vars and templates</a>
                </li>
                <li class="">
                    
    <a class="" href="../galaxy/">Setting up Load Balancer with Ansible Galaxy</a>
                </li>
                <li class="">
                    
    <a class="" href="../control_structures/">Controlling execution flow with conditionals, iterators and tags</a>
                </li>
                <li class="">
                    
    <a class="" href="../magicvars_envs/">Auto discovery and multi environments</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-vault/">Encrypting sensitive data with Ansible Vault</a>
                </li>
                <li class="">
                    
    <a class="" href="../update/">Setting up Zero Downtime Deployment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../dynamic_inventory/">Dynamic Inventory</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-windows/">Ansible on Windows</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-pull/">Ansible Pull</a>
                </li>
                <li class="">
                    
    <a class="" href="../ansible-pull/">Ansible Tower</a>
                </li>
                <li class="">
                    
    <a class="" href="../registered_variables/">Registered Variable</a>
                </li>
                <li class="">
                    
    <a class="" href="../custom_modules/">Custom Module</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Troubleshooting</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../troubleshooting/">Troubleshooting Techniques</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Ansible Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Bootcamp &raquo;</li>
        
      
    
    <li>Configuring app server environment with Roles</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="configuring-app-server-environment-with-roles">Configuring app server environment with Roles</h1>
<p>In the previous chapter, you have created and applied playbook for base systems configurations. Now is the time to start creating modular, reusable library of code for application configurations. In this chapter, we are going to write such modular code, in the form of roles and setup application server.  </p>
<p>We are going to create the roles with following specs,</p>
<p>apache role which will</p>
<ul>
<li>Install <strong>httpd</strong> package</li>
<li>configure <strong>httpd.conf</strong></li>
<li>Start <strong>httpd</strong> service</li>
<li>Add a <strong>handler</strong> to restart service</li>
</ul>
<p><strong>php</strong> role to</p>
<ul>
<li>install <strong>php</strong> and <strong>php-mysql</strong></li>
<li>restart apache when packages are installed</li>
</ul>
<p>We will also refactor  <strong>systems.yml</strong> and move all the tasks to its own role i.e. <strong>systems</strong></p>
<h3 id="creating-role-scaffolding-for-apache">Creating Role Scaffolding for Apache</h3>
<ul>
<li>Change working  directory to <strong>chap6</strong></li>
</ul>
<pre><code>cd  chap6
</code></pre>

<ul>
<li>Create roles directory</li>
</ul>
<pre><code>mkdir roles
</code></pre>

<ul>
<li>Generate role scaffolding using ansible-galaxy</li>
</ul>
<pre><code>ansible-galaxy init --offline --init-path=roles  apache
</code></pre>

<ul>
<li>Validate</li>
</ul>
<pre><code>tree roles/
</code></pre>

<p>[Output]</p>
<pre><code>  roles/
    └── apache
        ├── defaults
        │   └── main.yml
        ├── files
        ├── handlers
        │   └── main.yml
        ├── meta
        │   └── main.yml
        ├── README.md
        ├── tasks
        │   └── main.yml
        ├── templates
        ├── tests
        │   ├── inventory
        │   └── test.yml
        └── vars
            └── main.yml

</code></pre>

<h3 id="writing-tasks-to-install-and-start-apache-web-service">Writing Tasks to Install and Start  Apache Web Service</h3>
<p>We are going to create three different tasks files, one for each phase of application lifecycle
  * Install
  * Configure
  * Start Service</p>
<p>To begin with, in this part, we will install and start apache.</p>
<ul>
<li>To install apache, Create <strong>roles/apache/tasks/install.yml</strong></li>
</ul>
<pre><code>---
  - name: install apache web server
    yum:
      name: httpd
      state: installed
</code></pre>

<ul>
<li>To start the service, create  <strong>roles/apache/tasks/service.yml</strong> with the following content  </li>
</ul>
<pre><code>---
  - name: start apache webserver
    service:
      name: httpd
      state: started
      enabled: true
</code></pre>

<p>To have these tasks being called, include them into main task.</p>
<ul>
<li>Edit roles/apache/tasks/main.yml</li>
</ul>
<pre><code>---
# tasks file for apache
  - import_tasks: install.yml
  - import_tasks: service.yml
</code></pre>

<h3 id="create-and-apply-playbook-to-configure-app-servers">Create and apply playbook to configure app servers</h3>
<ul>
<li>Create a playbook for app servers <strong>app.yml</strong> with following contents</li>
</ul>
<pre><code>  ---
  - hosts: app
    become: true
    roles:
      - apache
</code></pre>

<ul>
<li>Apply app.yml with ansible-playbook</li>
</ul>
<pre><code>  ansible-playbook app.yml
</code></pre>

<p>[Output]</p>
<pre><code>PLAY [Playbook to configure App Servers] *********************************************************************

TASK [setup] *******************************************************************
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [apache : Install Apache...] **********************************************
changed: [192.168.61.13]
changed: [192.168.61.12]

TASK [apache : Starting Apache...] *********************************************
changed: [192.168.61.13]
changed: [192.168.61.12]

PLAY RECAP *********************************************************************
192.168.61.12              : ok=3    changed=2    unreachable=0    failed=0
192.168.61.13              : ok=3    changed=2    unreachable=0    failed=0
</code></pre>

<h3 id="managing-configurations">Managing Configurations</h3>
<ul>
<li>Copy <strong>index.html</strong> and <strong>httpd.conf</strong> from <strong>chap6/helper</strong> to <strong>/roles/apache/files/</strong> directory    </li>
</ul>
<pre><code>   cd chap6
   cp helper/httpd.conf roles/apache/files/  
</code></pre>

<ul>
<li>Create a task file at <strong>roles/apache/tasks/config.yml</strong> to copy the configuration file.    </li>
</ul>
<pre><code>---
  - name: copy over httpd configs
    copy:
      src: httpd.conf
      dest: /etc/httpd.conf
      owner: root
      group: root
      mode: 0644

</code></pre>

<h4 id="adding-notifications-and-handlers">Adding Notifications and Handlers</h4>
<ul>
<li>Previously we have create a task in roles/apache/tasks/config.yml to copy over httpd.conf to the app server. Update this file to send a notification to restart  service on configuration update.  You simply have to add the line which starts with <strong>notify</strong></li>
</ul>
<pre><code>---
  - name: copy over httpd configs
    copy:
      src: httpd.conf
      dest: /etc/httpd.conf
      owner: root
      group: root
      mode: 0644
    notify: Restart apache service
</code></pre>

<ul>
<li>Create the notification handler by updating   <strong>roles/apache/handlers/main.yml</strong>  </li>
</ul>
<pre><code>---
  - name: Restart apache service
    service: name=httpd state=restarted
</code></pre>

<p>Update <strong>tasks/main.yml</strong> to call the newly created tasks file.</p>
<pre><code>---
# tasks file for apache
  - import_tasks: install.yml
  - import_tasks: service.yml
  - import_tasks: config.yml
</code></pre>

<p>Apply and validate if the configuration file is being copied and service restarted.</p>
<pre><code> ansible-playbook app.yml
</code></pre>

<h2 id="create-a-role-to-install-php">Create a role to install php</h2>
<p>Generate roles scaffold</p>
<pre><code>ansible-galaxy init --offline --init-path=roles  php
</code></pre>

<p>roles/php/tasks/install.yml</p>
<pre><code>---
# install php related packages
  - name: install php
    package:
      name: &quot;{{ item }}&quot;
      state: installed
    with_items:
      - php
      - php-mysql
    notify: Restart apache service
</code></pre>

<p>file: roles/php/tasks/main.yml</p>
<pre><code>---
# tasks file for php
- import_tasks: install.yml
</code></pre>

<p>Update <strong>app.yml</strong> playbook to invoke php role.</p>
<p>file: app.yml</p>
<pre><code>  ---
  - hosts: app
    become: true
    roles:
      - apache
      - php
</code></pre>

<p>Apply the playbook</p>
<pre><code>ansible-playbook app.yml
</code></pre>

<h2 id="systems-role-dependencies-and-nested-roles">Systems role, dependencies and nested roles</h2>
<p>You have already written a playbook to define common systems configurations. Now, go ahead and refactor it so that instead of calling tasks from playbook itself, it goes into its own role, and then call on each server.</p>
<ul>
<li>Create a base role with ansible-galaxy utility,  </li>
</ul>
<pre><code>  ansible-galaxy init --offline --init-path=roles systems
</code></pre>

<ul>
<li>Copy over the  tasks from <strong>systems.yml</strong> and lets just add it to   <strong>/roles/base/tasks/main.yml</strong>  </li>
</ul>
<pre><code>---
# tasks file for systems
  - name: remove user dojo
    user: &gt;
      name=dojo
      state=absent

  - name: install tree utility
    yum: &gt;
      name=tree
      state=present

  - name: install ntp
    yum: &gt;
      name=ntp
      state=installed

</code></pre>

<ul>
<li>Define systems role as a dependency for  apache role,  </li>
<li>Update meta data for Apache by editing <strong>roles/apache/meta/main.yml</strong> and adding the following</li>
</ul>
<pre><code>---
dependencies:
 - {role: systems}
</code></pre>

<p>Next time you run  <strong>app.yml</strong>, observe if the above tasks get invoked as well.</p>
<h3 id="creating-a-site-wide-playbook">Creating a Site Wide Playbook</h3>
<p>We will create a site wide playbook, which will call all the plays required to configure the complete infrastructure. Currently we have a single  playbook for App Servers. However, in future we would create many.</p>
<ul>
<li>Create <strong>site.yml</strong> in /vagrant/chap5 directory and add the following content</li>
</ul>
<pre><code>  ---
  # This is a sitewide playbook
  # filename: site.yml
  - import_playbook: app.yml

</code></pre>

<ul>
<li>Execute sitewide playbook as</li>
</ul>
<pre><code>ansible-playbook site.yml
</code></pre>

<p>[Output]</p>
<pre><code>
PLAY [Playbook to configure App Servers] ***************************************

TASK [setup] *******************************************************************
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [base : create admin user] ************************************************
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [base : remove dojo] ******************************************************
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [base : install tree] *****************************************************
ok: [192.168.61.13]
ok: [192.168.61.12]

TASK [base : install ntp] ******************************************************
ok: [192.168.61.13]
ok: [192.168.61.12]

TASK [base : start ntp service] ************************************************
ok: [192.168.61.13]
ok: [192.168.61.12]

TASK [apache : Installing Apache...] *******************************************
ok: [192.168.61.13]
ok: [192.168.61.12]

TASK [apache : Starting Apache...] *********************************************
ok: [192.168.61.13]
ok: [192.168.61.12]

TASK [apache : Copying configuration files...] *********************************
ok: [192.168.61.12]
ok: [192.168.61.13]

TASK [apache : Copying index.html file...] *************************************
ok: [192.168.61.12]
ok: [192.168.61.13]

PLAY RECAP *********************************************************************
192.168.61.12              : ok=10   changed=0    unreachable=0    failed=0
192.168.61.13              : ok=10   changed=0    unreachable=0    failed=0
</code></pre>

<h2 id="exercises">Exercises</h2>
<h3 id="nano-project-deploy-a-php-application">Nano Project: Deploy a PHP Application</h3>
<p>devops-demo-app is an application written in  PHP. You have already setup the environment above with apache and php roles, to deploy this application.  Your job is to write the ansible code to  deploy this application on app servers. This code will be in the form of a role.</p>
<p>You have been tasked to create a <strong>froentend</strong>  role with the following specs,</p>
<ul>
<li>Pull release packages from the github release page as provided in the resources below. Releases are in the form of an archive.</li>
<li>Multiple copies of releases will be maintained on the app servers for enabling rollbacks. To support this, every time to deploy a new version of the app, create a new directory for it inside the /opt/app</li>
</ul>
<pre><code>e.g.

opt
  | __ app
         \__ release
                 |
                 |____ devops-demo-app-1.0
                 |
                 |____ devops-demo-app-1.1

</code></pre>

<ul>
<li>Create  a symlink from the current version path to  <strong>/var/www/html/app</strong></li>
</ul>
<pre><code>e.g.

[root@app2 /]# ls -l /var/www/html/
total 8
lrwxrwxrwx 1 root root   36 Jan 16 13:28 app -&gt; /opt/app/release/devops-demo-app-1.1

</code></pre>

<p><strong>Resources</strong>:</p>
<ul>
<li><strong>PHP App Source</strong> : https://github.com/devopsdemoapps/devops-demo-app</li>
<li><strong>Releases</strong>: https://github.com/devopsdemoapps/devops-demo-app/releases</li>
</ul>
<p>Once deployed, visiting  <img alt="http://IADDRESS:81/app" src="http://IADDRESS:81/app" /> for app1 or with port 82 for (app2) should show the web app deployed.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../templates_and_variables/" class="btn btn-neutral float-right" title="Making roles reusable with vars and templates">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../playbooks/" class="btn btn-neutral" title="Writing Playbook for Base System Configurations"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../playbooks/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../templates_and_variables/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
